<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>WebSocket ë¡œê·¸ì¸ + í…ŒìŠ¤íŠ¸</title>
</head>
<body>

<h2>WebSocket í…ŒìŠ¤íŠ¸</h2>

<button onclick="login()">1ï¸âƒ£ ë¡œê·¸ì¸</button>
<button onclick="connectWs()">2ï¸âƒ£ WebSocket ì—°ê²°</button>
<button onclick="sendMessage()">3ï¸âƒ£ ë©”ì‹œì§€ ë³´ë‚´ê¸°</button>

<pre id="log"></pre>

<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

<script>
    let stompClient = null;

    function log(msg) {
        console.log(msg);
        document.getElementById("log").innerText += msg + "\n";
    }

    /* ======================
       1ï¸âƒ£ ë¡œê·¸ì¸
    ====================== */
    function login() {
        fetch("http://localhost:8080/api/user/sign-in", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                email: "aaa@aaa.com",
                password: "123!"
            })
        })
            .then(res => res.json())
            .then(data => {
                log("ë¡œê·¸ì¸ ì‘ë‹µ ìˆ˜ì‹ ");

                const accessToken = data?.resultData?.accessToken;
                if (!accessToken) {
                    log("âŒ accessToken ì—†ìŒ");
                    return;
                }

                localStorage.setItem("accessToken", accessToken);
                log("âœ… ë¡œê·¸ì¸ ì„±ê³µ, í† í° ì €ì¥ ì™„ë£Œ");
            })
            .catch(err => {
                log("âŒ ë¡œê·¸ì¸ ì‹¤íŒ¨");
                console.error(err);
            });
    }

    /* ======================
       2ï¸âƒ£ WebSocket ì—°ê²°
    ====================== */
    function connectWs() {
        const accessToken = localStorage.getItem("accessToken");
        if (!accessToken) {
            log("âŒ ë¨¼ì € ë¡œê·¸ì¸ í•˜ì„¸ìš”");
            return;
        }

        const socket = new SockJS("http://localhost:8080/ws");
        stompClient = Stomp.over(socket);

        stompClient.connect(
            {
                Authorization: "Bearer " + accessToken
            },
            () => {
                log("ğŸ”Œ WebSocket ì—°ê²° ì„±ê³µ");

                // âœ… í•˜ë“œì½”ë”© ì œê±° (ë¡œê·¸ì¸ ìœ ì € ìë™ ë§¤í•‘)
                stompClient.subscribe("/user/queue/notify", msg => {
                    log("ğŸ“© ë°›ì€ ì•Œë¦¼: " + msg.body);
                });
            },
            error => {
                log("âŒ WebSocket ì—°ê²° ì‹¤íŒ¨");
                console.error(error);
            }
        );
    }

    /* ======================
       3ï¸âƒ£ ë©”ì‹œì§€ ì „ì†¡
    ====================== */
    function sendMessage() {
        if (!stompClient || !stompClient.connected) {
            log("âŒ WebSocket ì—°ê²° ì•ˆ ë¨");
            return;
        }

        stompClient.send(
            "/app/notify",
            {},
            JSON.stringify({
                message: "ì›¹ì†Œì¼“ ì•Œë¦¼ í…ŒìŠ¤íŠ¸"
            })
        );

        log("â¡ï¸ ë©”ì‹œì§€ ì „ì†¡ ì™„ë£Œ");
    }
</script>

</body>
</html>